#!/bin/sh

export BASE=$(realpath `dirname $0`)
cd $BASE

case $1 in
inst)
    SRC="./install"
    CMD=( ${@:2} )
    
    [[ ! $CMD ]] && \
        echo -e "Usage: $(basename $0) install ..." && \
        exit 0

    for item in ${CMD[@]}; do
        echo -e "$item -> $SRC/$item"
    done
    ;;

info)
    SRC="$BASE/install"
    CMD=( ${@:2} )
    
    [[ ! $CMD ]] && \
        echo -e "Usage: $(basename $0) info ..." && \
        CMD=( 'extra/test' 'extra/test1' )

    for item in ${CMD[@]}; do
        echo "-->>> $SRC/$item"
        if [[ -d $SRC/$item ]]; then
            echo "    - packages group"
            ls -p $SRC/$item
        else
            echo "    - package $item"

            PKGS=()
            CONFIGS=()

            source $SRC/$item

            echo -e "\033[32m-- Info from '${TITLE:-$item}' --\033[0m"
            echo -e "Packages:\n\t${PKGS[@]}"

            echo -e "Configs:\n\t${CONFIGS[@]}"

            declare -f "post_install" > /dev/null && post_install
        fi
    done
    ;;

install)
    SRC="./install"
    CMD=( ${@:2} )

    [[ -d $SRC/$2 ]] && \
        CMD=( ${@:3} ) && SRC="$SRC/$2"

    [[ $CMD = "*" ]] && \
        echo "Install all packages from $SRC" && \
        CMD=$(ls $SRC)

    [[ ! $CMD ]] && \
        echo -e "Usage: $(basename $0) install {package name|extra|*}" && \
        ls -p $SRC && exit 0

    for item in ${CMD[@]}; do
        [[ -d $SRC/$item ]] && continue

        if [[ -x $SRC/$item ]]; then
            echo -e "\033[33m  install: $SRC/$item\033[0m"
            ./$SRC/$item
        else
            echo -e "\033[31mError: package $item not found!\033[0m"
            exit 1
        fi
    done
    ;;

status)
    while IFS=\# read -r item _; do
        item=$(echo $item | sed 's/ *$//g') && [[ ${item} ]] && \
            ./lib/syncopy "$HOME/$item" "$BASE/backup/$item" simular
    done < ./CONFIGS
    ;;

backup)
    echo -e "-- Copy configs to $BASE/backup repository --"

    while IFS=\# read -r item _; do
        item=$(echo $item | sed 's/ *$//g') && [[ ${item} ]] && \
            ./lib/syncopy "$HOME/$item" "$BASE/backup/$item"
    done < ./CONFIGS
    ;;

restore)
    echo -e "-- Copy configs from $BASE/backup repository --"

    while IFS=\# read -r item _; do
        item=$(echo $item | sed 's/ *$//g') && [[ ${item} ]] && \
            ./lib/syncopy "$BASE/backup/$item" "$HOME/$item"
    done < ./CONFIGS
    ;;

clean)
    echo -e "\033[31m-- Clean $BASE/backup directory --\033[0m"
    rm -rf $BASE/backup
    ;;

*)
    echo -e "Usage: $(basename $0) {install|status|backup|restore|clean}"
    echo -e "       $(basename $0) install {package name|all|extra} ..."
    ;;

esac
